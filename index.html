<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sentient Türkiye Community Map — GemBatu</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--card:rgba(0,0,0,.72);--fg:#eaf2ff;--muted:#aab6d1;--btn:#2563eb;--btnh:#1d4ed8}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      color:var(--fg);
      background:url("assets/bg.jpg") no-repeat center center fixed;
      background-size:cover;
    }
    .container{max-width:1100px;margin:0 auto;padding:28px 16px;}
    h2{margin:0 0 16px 0;text-shadow:0 2px 10px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .stack{display:grid;gap:16px}
    .card{
      background:var(--card);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      pointer-events:auto;
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label.small{font-size:12px;color:var(--muted)}
    select,input,textarea,button{
      width:100%;padding:10px 12px;border:0;border-radius:10px;outline:none;
    }
    select,input,textarea{background:#0f172a;color:#e5edff}
    textarea{min-height:72px;resize:vertical}
    button{background:var(--btn);color:#fff;cursor:pointer;font-weight:600}
    button:hover{background:var(--btnh)}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1222;color:#cfe1ff}
    .list div{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .muted{color:var(--muted)}
    /* Etkinlik listesi büyüdükçe aşağı kayabilsin */
    #eventsList{max-height:360px;overflow-y:auto;}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h2>Sentient Türkiye Community Map — <b>GemBatu</b> <span class="muted" style="font-size:12px">(production)</span></h2>

    <div class="grid">
      <!-- LEFT: Join + Events -->
      <div class="stack">
        <!-- Join -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Join the map</h3>
            <label class="small">Enter a nickname (will be public) and select your city.</label>
          </div>

          <div class="row">
            <input id="nickname" placeholder="Your nickname (e.g., @GemBatu)" style="flex:1;max-width:280px"/>
            <span id="nickStatus" class="pill">Not set</span>
          </div>

          <label class="small">Select your city (Türkiye)</label>
          <select id="citySelect"></select>

          <div class="row" style="justify-content:flex-end">
            <button id="btnSaveCity" style="max-width:180px" type="button">Save my entry</button>
          </div>
        </div>

        <!-- Events -->
        <div class="card">
          <h3 style="margin-top:0">Community events</h3>
          <label class="small">City</label>
          <select id="eventCity"></select>

          <input id="eventTitle" placeholder="Event title (e.g., Eskişehir meetup)"/>
          <input id="eventDate" type="datetime-local"/>
          <input id="eventVenue" placeholder="Venue / address"/>
          <textarea id="eventDesc" placeholder="Short description (optional)"></textarea>

          <div class="row" style="justify-content:flex-end">
            <button id="btnCreateEvent" style="max-width:160px" type="button">Create event</button>
          </div>

          <div id="eventsList" class="list muted">No events for this city yet.</div>
        </div>
      </div>

      <!-- RIGHT: City browser -->
      <div class="card">
        <h3 style="margin-top:0">City browser</h3>
        <div class="row">
          <select id="browserCity" style="flex:1"></select>
          <!-- İstediğin davranış: seçilen şehrin listesini bu tuşla uygula; ALL seçiliyse hepsi -->
          <button id="btnShowAll" style="max-width:120px" type="button">Show all</button>
        </div>

        <div class="row" style="gap:12px;margin-top:6px">
          <span id="totalCount" class="pill">0 total members</span>
          <span id="cityCount" class="pill">0 in this city</span>
        </div>

        <div id="membersList" class="list muted" style="margin-top:10px">No members yet.</div>
      </div>
    </div>
  </div>

  <script>
    // --- Supabase setup (Nickname-only) ---
    const SUPABASE_URL = "https://zooclwpqfwpzwosnqjem.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // UI refs
    const nickname = document.getElementById('nickname');
    const nickStatus = document.getElementById('nickStatus');
    const citySelect = document.getElementById('citySelect');
    const btnSaveCity = document.getElementById('btnSaveCity');

    const browserCity = document.getElementById('browserCity');
    const btnShowAll = document.getElementById('btnShowAll');
    const membersList = document.getElementById('membersList');
    const totalCount = document.getElementById('totalCount');
    const cityCount = document.getElementById('cityCount');

    const eventCity = document.getElementById('eventCity');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventVenue = document.getElementById('eventVenue');
    const eventDesc = document.getElementById('eventDesc');
    const btnCreateEvent = document.getElementById('btnCreateEvent');
    const eventsList = document.getElementById('eventsList');

    // 81 il (A→Z)
    const CITIES = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur",
      "Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan",
      "Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkâri","Hatay","Iğdır","Isparta","İstanbul",
      "İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir",
      "Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş",
      "Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas",
      "Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];
    function fillCitySelect(el, includeAll=false){
      el.innerHTML = "";
      if(includeAll){
        const opt = document.createElement('option');
        opt.value = "ALL"; opt.textContent = "All cities";
        el.appendChild(opt);
      }
      CITIES.forEach(c=>{
        const o = document.createElement('option');
        o.value = c; o.textContent = c;
        el.appendChild(o);
      });
    }
    fillCitySelect(citySelect);
    fillCitySelect(eventCity);
    fillCitySelect(browserCity, true);

    // Tarayıcıya kalıcı anonim id
    function getClientId(){
      let cid = localStorage.getItem('cid');
      if(!cid){
        cid = (self.crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) + "_anon";
        localStorage.setItem('cid', cid);
      }
      return cid;
    }
    // Nick'i yerelden yükle
    function reflectNick(){
      const n = localStorage.getItem('nick') || "";
      nickname.value = n;
      nickStatus.textContent = n ? "Nickname: " + n : "Not set";
    }
    reflectNick();

    // Kayıt kaydet (nickname + city) → sağ panelde herkes görsün
    btnSaveCity.addEventListener('click', async ()=>{
      const userId = getClientId();
      const userName = nickname.value.trim();
      const city = citySelect.value;
      if(!userName){ alert("Please enter a nickname."); return; }
      if(!city){ alert("Please select a city."); return; }

      localStorage.setItem('nick', userName);
      reflectNick();

      // Cihaz-id’ye göre upsert: aynı cihazda şehir güncelleme yapar
      const { error } = await supa.from('users')
        .upsert({ id: userId, username: userName, city }, { onConflict: 'id' });
      if(error){ alert("Save error: " + error.message); return; }

      await refreshMembersUI(currentBrowserCity); // mevcut filtreyi koru
      alert("Your city has been saved.");
    });

    // Sağ panel (City browser): filtre ancak “Show all” ile uygulanır
    function currentBrowserCity(){
      const v = browserCity.value;
      return (v && v !== "ALL") ? v : null;
    }
    async function refreshMembersUI(getCityFn){
      const selectedCity = typeof getCityFn === "function" ? getCityFn() : null;

      // toplam üye
      const total = await supa.from('users').select('id');
      totalCount.textContent = (total.data?.length || 0) + " total members";

      let q = supa.from('users').select('username,city').order('username',{ascending:true});
      if(selectedCity) q = q.eq('city', selectedCity);

      const { data, error } = await q;
      if(error){ membersList.innerHTML = "Error: "+error.message; return; }

      cityCount.textContent = (data?.length || 0) + " in this city";
      membersList.innerHTML = (!data || data.length===0)
        ? "No members yet."
        : data.map(u => `<div>@${u.username} — ${u.city}</div>`).join('');
    }
    // Şehir değişiminde otomatik filtreleme YOK; özellikle butonla uygula
    btnShowAll.addEventListener('click', ()=> refreshMembersUI(currentBrowserCity));

    // Etkinlikler (şehir bazlı, tarih artan)
    async function refreshEvents(city){
      let q = supa.from('events')
        .select('title,event_date,venue,description,city')
        .order('event_date',{ascending:true, nullsLast:true});
      if(city) q = q.eq('city', city);
      const { data, error } = await q;
      if(error){ eventsList.innerHTML = "Error: "+error.message; return; }
      if(!data || data.length===0){ eventsList.innerHTML = "No events for this city yet."; return; }
      eventsList.innerHTML = data.map(e=>{
        const dt = e.event_date ? new Date(e.event_date).toLocaleString() : "";
        return `<div><b>${e.title}</b> — ${e.city}<br>${dt}${e.venue? " @ "+e.venue:""}<br><span class="muted">${e.description||""}</span></div>`;
      }).join('<div style="height:8px"></div>');
    }
    // Event şehri değişince anında o şehrin etkinlikleri
    eventCity.addEventListener('change', ()=> refreshEvents(eventCity.value));

    btnCreateEvent.addEventListener('click', async ()=>{
      const title = eventTitle.value.trim();
      const city  = eventCity.value;
      if(!title || !city){ alert("Please fill city and title."); return; }

      const payload = {
        city,
        title,
        event_date: eventDate.value || null,  // kolaylık için; istersen ISO'ya çevirebiliriz
        venue: eventVenue.value.trim(),
        description: eventDesc.value.trim(),
        created_by: getClientId()
      };
      const { error } = await supa.from('events').insert(payload);
      if(error){ alert("Error: "+error.message); return; }

      eventTitle.value = ""; eventVenue.value = ""; eventDesc.value = "";
      await refreshEvents(eventCity.value); // anında güncelle
      alert("Event created.");
    });

    // Realtime açıksa dinle (anında yenile); değilse polling devrede
    supa.channel('realtime-users')
      .on('postgres_changes',{event:'INSERT', schema:'public', table:'users'}, ()=> refreshMembersUI(currentBrowserCity))
      .on('postgres_changes',{event:'UPDATE', schema:'public', table:'users'}, ()=> refreshMembersUI(currentBrowserCity))
      .subscribe();

    supa.channel('realtime-events')
      .on('postgres_changes',{event:'INSERT', schema:'public', table:'events'}, (payload)=>{
        const watchCity = eventCity.value;
        if(!watchCity || payload.new.city === watchCity) refreshEvents(watchCity);
      })
      .subscribe();

    // Ek garanti: otomatik tazeleme (realtime kapalı olsa da işler)
    setInterval(()=> refreshEvents(eventCity.value), 15000);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshEvents(eventCity.value); });

    // İlk yükleme
    (async ()=>{
      reflectNick();
      await refreshMembersUI(null);          // başlangıçta tamamı
      await refreshEvents(eventCity.value);  // seçili şehir (ilk option)
    })();
  </script>
</body>
</html>
