<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentient Türkiye Community Map — GemBatu (production)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --bg:#0E1525;
      --panel:#0F1828;
      --text:#E9F0FF;
      --muted:#9FB0C8;
      --accent:#5F9BFF;
      --border:#1F2B43;
      --chip:#15243A;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text); background:var(--bg);
      position:relative; overflow-x:hidden;
    }

    /* Arka plan görseli: tıklamaları asla kapatmasın */
    .bg{
      position:fixed; inset:0;
      background:url("./assets/bg.jpg") center / cover no-repeat fixed;
      z-index:0; pointer-events:none !important;
    }

    .wrap{position:relative; z-index:10; max-width:1120px; margin:32px auto 120px; padding:0 16px}
    h1{margin:0 0 16px; font-size:20px; font-weight:700; letter-spacing:.2px}
    .badge{display:inline-block; margin-left:8px; font-size:11px; padding:3px 8px; border-radius:999px; background:var(--chip); color:var(--muted); border:1px solid var(--border)}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    .panel{
      position:relative; z-index:15;
      background:rgba(15,24,40,.88);
      border:1px solid var(--border);
      border-radius:14px; padding:16px;
      backdrop-filter:blur(6px);
      box-shadow:0 6px 24px rgba(0,0,0,.28);
    }
    .title{font-weight:600; margin-bottom:12px}
    .muted{color:var(--muted); font-size:12px}
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px}

    input,select,textarea{
      width:100%; padding:11px 12px; border-radius:10px;
      background:#0F1626; border:1px solid var(--border); color:var(--text); outline:none
    }
    textarea{min-height:62px; resize:vertical}
    .btn{
      appearance:none; cursor:pointer; font-weight:600;
      border:1px solid rgba(255,255,255,.08);
      padding:10px 14px; border-radius:10px; background:#15233a; color:var(--text)
    }
    .btn.primary{background:linear-gradient(180deg,#3E79FF,#2E5ED6); border-color:#2E5ED6}
    .btn.ghost{background:transparent}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0}
    .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:11px}
    .list{display:grid; gap:8px; margin-top:8px}
    .item{display:flex; justify-content:space-between; align-items:center; gap:10px; background:#0F1626; border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .top{display:flex; align-items:center; justify-content:space-between; gap:8px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    /* === CLICK HOTFIX ===
       Tüm etkileşimli öğeleri en öne al, arka plan ve olası overlay’lerin tıklamayı engellemesini önle */
    button, select, input, textarea, a { position:relative; z-index:20; pointer-events:auto !important; }
    .panel * { pointer-events:auto; }
    /* Eğer başka sabit/absolute bir katman varsa, aşağıyı güvenlik için bırakıyorum:
       .overlay, .cover, .hero, .mask { pointer-events:none !important; } */
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="wrap">
    <h1>Sentient Türkiye Community Map — GemBatu <span class="badge">production</span></h1>

    <div class="grid">
      <!-- LEFT: Join the map -->
      <div class="panel" id="join-panel">
        <div class="top">
          <div class="title">Join the map</div>
          <span class="badge">Built for the community ✨</span>
        </div>

        <p class="muted" id="login-note">
          You must connect Discord to add your city.<br>
          <span style="color:#ffd27a">(When you log in here, your Discord username will be visible to everyone)</span>
        </p>

        <div class="list" style="gap:10px">
          <button class="btn primary" id="btn-login">Sign in with Discord</button>
          <div class="muted" id="whoami" style="display:none"></div>

          <div>
            <label for="city-select">Select your city (Türkiye)</label>
            <select id="city-select"></select>
          </div>
          <div>
            <button class="btn" id="btn-save">Save my entry</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: City browser -->
      <div class="panel">
        <div class="top">
          <div class="title">City browser</div>
          <button class="btn ghost" id="btn-show-all">Show all</button>
        </div>

        <div class="two">
          <select id="browser-city"></select>
          <div class="chips">
            <span class="chip" id="chip-total">0 total members</span>
            <span class="chip" id="chip-in">0 in this city</span>
          </div>
        </div>

        <div class="list" id="members-list">
          <div class="muted">No members yet.</div>
        </div>
      </div>
    </div>

    <!-- EVENTS -->
    <div class="panel" style="margin-top:16px">
      <div class="title">Community events</div>

      <label for="events-city-select">City</label>
      <select id="events-city-select"></select>

      <label for="ev-title">Event title (e.g., Eskişehir meetup)</label>
      <input id="ev-title" placeholder="Event title">

      <div class="two">
        <div>
          <label for="ev-datetime">Date & time</label>
          <input id="ev-datetime" type="datetime-local">
        </div>
        <div>
          <label for="ev-venue">Venue / address</label>
          <input id="ev-venue" placeholder="Venue / address">
        </div>
      </div>

      <label for="ev-desc">Short description (optional)</label>
      <textarea id="ev-desc" placeholder="Short description..."></textarea>

      <button class="btn primary" id="btn-create" style="margin-top:8px">Create event</button>

      <div class="list" id="events-list" style="margin-top:12px">
        <div class="muted">No events for this city yet.</div>
      </div>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const SUPABASE_URL  = "https://zooclwpqfwpzwosnqjem.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---- CITIES ----
    const TR_CITIES = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur",
      "Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan",
      "Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul",
      "İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kilis","Kırıkkale","Kırklareli",
      "Kırşehir","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş",
      "Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas",
      "Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];

    // ---- DOM ----
    const $ = s => document.querySelector(s);
    const citySelect = $('#city-select');
    const browserCity = $('#browser-city');
    const eventsCitySelect = $('#events-city-select');
    const membersList = $('#members-list');
    const chipTotal = $('#chip-total');
    const chipIn = $('#chip-in');
    const whoami = $('#whoami');
    const loginBtn = $('#btn-login');

    function fillCities(sel){ sel.innerHTML = TR_CITIES.map(c=>`<option value="${c}">${c}</option>`).join(''); }
    fillCities(citySelect); fillCities(browserCity); fillCities(eventsCitySelect);

    // ---- AUTH ----
    let currentUser = null;

    async function syncAuthUI(){
      const { data:{ user } } = await supabase.auth.getUser();
      currentUser = user || null;

      if(currentUser){
        loginBtn.style.display='none';
        whoami.style.display='block';
        $('#login-note').style.display='none';
        whoami.textContent = `Signed in as @${currentUser.user_metadata?.full_name || currentUser.user_metadata?.preferred_username || 'Discord user'}`;
      }else{
        loginBtn.style.display='inline-block';
        whoami.style.display='none';
        $('#login-note').style.display='block';
      }
    }

    loginBtn.addEventListener('click', async ()=>{
      const redirectTo = window.location.origin + window.location.pathname;
      await supabase.auth.signInWithOAuth({ provider:'discord', options:{ redirectTo }});
    });

    supabase.auth.onAuthStateChange(async ()=>{
      await syncAuthUI();
      await fetchOwnProfileIntoUI();
      await refreshMembers();
      await refreshEventsUI();
      attachRealtimeEvents();
    });

    // ---- USERS ----
    async function fetchOwnProfileIntoUI(){
      if(!currentUser) return;
      const { data } = await supabase.from('users').select('*').eq('discord_id', currentUser.id).maybeSingle();
      if(data?.city){ citySelect.value = data.city; }
    }

    $('#btn-save').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Please sign in with Discord first.');
      const city = citySelect.value;
      const username = currentUser.user_metadata?.full_name || currentUser.user_metadata?.preferred_username || 'discord_user';

      const { error } = await supabase.from('users').upsert(
        { discord_id: currentUser.id, username, city },
        { onConflict:'discord_id' }
      );
      if(error) return alert('Save error: '+error.message);
      await refreshMembers();
      alert('Saved ✅');
    });

    // ---- MEMBERS (browser) ----
    async function refreshMembers(){
      const { count:total } = await supabase.from('users').select('*', { count:'exact', head:true });
      chipTotal.textContent = `${total ?? 0} total members`;

      const city = browserCity.value;
      let q = supabase.from('users').select('*').order('username', { ascending:true });
      if(city) q = q.eq('city', city);
      const { data, error } = await q;
      if(error){ membersList.innerHTML=`<div class="muted">Error loading members.</div>`; return; }

      chipIn.textContent = `${data.length} in this city`;
      if(!data.length){ membersList.innerHTML=`<div class="muted">No members yet.</div>`; return; }

      membersList.innerHTML = data.map(u=>(
        `<div class="item">
           <div>@${escapeHtml(u.username || 'discord_user')}</div>
           <small>${u.city||''}</small>
         </div>`
      )).join('');
    }
    browserCity.addEventListener('change', refreshMembers);
    $('#btn-show-all').addEventListener('click', ()=>{ browserCity.value=''; refreshMembers(); });

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    // ---- EVENTS ----
    $('#btn-create').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Please sign in to create events.');
      const city = eventsCitySelect.value;
      const title = $('#ev-title').value.trim();
      const dt = $('#ev-datetime').value;
      const venue = $('#ev-venue').value.trim();
      const description = $('#ev-desc').value.trim();
      if(!city || !title || !dt) return alert('City, title and date/time are required.');

      const row = { city, title, description, venue, event_date: dt, created_by: currentUser.id };
      const { error } = await supabase.from('events').insert(row);
      if(error) return alert('Create error: '+error.message);

      $('#ev-title').value=''; $('#ev-datetime').value=''; $('#ev-venue').value=''; $('#ev-desc').value='';
      await refreshEventsUI();
      alert('Event created ✅');
    });

    function renderEvents(list){
      const box = $('#events-list');
      if(!list?.length){ box.innerHTML = `<div class="muted">No events for this city yet.</div>`; return; }
      box.innerHTML = list.map(ev=>{
        const when = ev.event_date ? new Date(ev.event_date).toLocaleString() : '';
        const ven  = ev.venue ? ` • ${escapeHtml(ev.venue)}` : '';
        const desc = ev.description ? `<br><small class="muted">${escapeHtml(ev.description)}</small>` : '';
        return `<div class="item">
                  <div><strong>${escapeHtml(ev.title)}</strong>
                    <small> (${escapeHtml(ev.city)} • ${when}${ven})</small>${desc}
                  </div>
                </div>`;
      }).join('');
    }

    async function refreshEventsUI(){
      const c = eventsCitySelect.value;
      let q = supabase.from('events').select('*').order('event_date', { ascending:true });
      if(c) q = q.eq('city', c);
      const { data } = await q;
      renderEvents(data || []);
    }
    eventsCitySelect.addEventListener('change', refreshEventsUI);

    // --- Realtime: events ---
    let evChannel = null;
    function attachRealtimeEvents(){
      try{
        if(evChannel){ supabase.removeChannel(evChannel); evChannel=null; }
        evChannel = supabase
          .channel('events-realtime')
          .on('postgres_changes', { event:'*', schema:'public', table:'events' }, ()=> refreshEventsUI())
          .subscribe();
      }catch(e){ console.warn(e); }
    }

    // ---- INIT ----
    (async function(){
      await syncAuthUI();
      await fetchOwnProfileIntoUI();
      await refreshMembers();
      await refreshEventsUI();
      attachRealtimeEvents();
    })();
  </script>
</body>
</html>
