<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sentient Türkiye Community Map — GemBatu</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1521;
      --panel:#111a2b;
      --panel-2:#0d1627;
      --text:#e9eefb;
      --muted:#a9b4cc;
      --accent:#5da8ff;
      --good:#2ecc71;
      --chip:#1b2740;
      --chipText:#cfe0ff;
      --danger:#ff5b5b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:var(--bg);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height:1.35; overflow-y:overlay;
      /* background image */
      background-image:url("/assets/bg.jpg");
      background-size:cover; background-position:center; background-attachment:fixed;
    }
    .scrim{
      position:fixed; inset:0; pointer-events:none;
      background:linear-gradient(180deg, rgba(15,21,33,.65), rgba(15,21,33,.55));
      z-index:0;
    }
    .wrap{
      position:relative; z-index:1;
      max-width:1100px; margin:40px auto 120px; padding:0 16px;
    }
    h1{
      font-family:"Space Grotesk",Inter,system-ui;
      font-size:22px; font-weight:600; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px; margin:0 0 14px;
    }
    .badge{font-size:12px;background:#233252;color:#cfe0ff;border-radius:999px;padding:4px 8px}

    .grid{
      display:grid; gap:18px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .card h2{font-size:14px; letter-spacing:.4px; margin:0 0 10px; color:#cfe0ff}

    .row{display:flex; gap:10px; align-items:center}

    .btn{
      appearance:none; border:0; border-radius:10px; padding:10px 14px;
      background:#1b5cff; color:white; font-weight:600; cursor:pointer;
      box-shadow:0 6px 16px rgba(27,92,255,.35);
      transition:transform .05s ease, filter .2s ease; user-select:none;
    }
    .btn:active{ transform:translateY(1px) }
    .btn:disabled{filter:grayscale(.7); opacity:.6; cursor:not-allowed}

    .btn-secondary{background:#253658; color:#e9eefb; box-shadow:none}
    .btn-ghost{background:#1a2339; color:#d8e6ff; box-shadow:none; border:1px solid rgba(255,255,255,.07)}

    .select, .input{
      width:100%; background:#0e1729; color:var(--text);
      border:1px solid rgba(255,255,255,.1); border-radius:10px;
      padding:11px 12px; outline:none; font:inherit;
    }
    .input::placeholder{color:#7f8aa6}
    .muted{color:var(--muted); font-size:12px}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px}
    .chip{background:var(--chip); color:var(--chipText); padding:6px 8px; border-radius:999px; font-size:12px}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .item{
      background:#0c1322; border:1px solid rgba(255,255,255,.06);
      border-radius:10px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center;
    }
    .empty{color:#94a3c7; font-size:13px; padding:12px}

    /* Events */
    .events-form .row{gap:10px}
    .events-form .col{flex:1}
    .events-form .col-2{flex:2}
    .events-form .col-3{flex:3}
    .divider{height:1px;background:rgba(255,255,255,.06); margin:14px 0}
    .good{color:var(--good)}
    .danger{color:var(--danger)}

    /* Z-index fix so everything is clickable */
    .card, .btn, .input, .select { position:relative; z-index:2 }
  </style>
</head>
<body>
  <div class="scrim"></div>
  <div class="wrap">
    <h1>
      Sentient Türkiye Community Map — GemBatu
      <span class="badge">production</span>
    </h1>

    <div class="grid">
      <!-- Left: Join -->
      <div class="card" id="joinCard">
        <h2>Join the map</h2>
        <p class="muted" id="joinHint">You must connect Discord to add your city.</p>

        <div class="row" style="margin-top:6px;">
          <button class="btn" id="btnDiscord">Sign in with Discord</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <select id="citySelect" class="select" disabled></select>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-secondary" id="btnSaveCity" disabled>Save my entry</button>
        </div>
      </div>

      <!-- Right: Browser -->
      <div class="card">
        <h2>City browser</h2>

        <div class="row" style="gap:8px">
          <select id="browserCity" class="select"></select>
          <button class="btn-ghost" id="btnShowAll">Show all</button>
        </div>

        <div class="chips">
          <span class="chip" id="chipTotal">0 total members</span>
          <span class="chip" id="chipCity">0 in this city</span>
        </div>

        <div id="membersList" class="list"></div>
      </div>
    </div>

    <!-- Events -->
    <div class="card" style="margin-top:18px;">
      <h2>Community events</h2>

      <div class="row" style="gap:8px; margin-bottom:8px;">
        <select id="eventsCity" class="select" style="max-width:320px"></select>
        <div class="muted" id="eventsInfo">Only signed-in users can create events.</div>
      </div>

      <form id="formEvent" class="events-form" autocomplete="off">
        <div class="row" style="flex-wrap:wrap">
          <div class="col-3">
            <input id="eventTitle" class="input" type="text" placeholder="Event title (e.g., Eskişehir meetup)" />
          </div>
          <div class="col">
            <input id="eventDate" class="input" type="datetime-local" />
          </div>
          <div class="col-2">
            <input id="eventVenue" class="input" type="text" placeholder="Venue / address" />
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="eventDesc" class="input" type="text" placeholder="Short description (optional)" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" type="submit" id="btnCreateEvent">Create event</button>
        </div>
      </form>

      <div class="divider"></div>
      <div id="eventsList" class="list"></div>
    </div>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://zooclwpqfwpzwosnqjem.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // 81 il (kısaltılmış: tam liste)
    const CITIES = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur",
      "Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan",
      "Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkâri","Hatay","Iğdır","Isparta","İstanbul",
      "İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir",
      "Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş",
      "Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas",
      "Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];

    // Elmanları çek
    const btnDiscord = document.getElementById('btnDiscord');
    const citySelect = document.getElementById('citySelect');
    const btnSaveCity = document.getElementById('btnSaveCity');

    const browserCity = document.getElementById('browserCity');
    const btnShowAll = document.getElementById('btnShowAll');
    const membersList = document.getElementById('membersList');
    const chipTotal = document.getElementById('chipTotal');
    const chipCity = document.getElementById('chipCity');

    const eventsCity = document.getElementById('eventsCity');
    const formEvent = document.getElementById('formEvent');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventVenue = document.getElementById('eventVenue');
    const eventDesc  = document.getElementById('eventDesc');
    const eventsList = document.getElementById('eventsList');
    const joinHint   = document.getElementById('joinHint');
    const eventsInfo = document.getElementById('eventsInfo');

    // Select'leri doldur
    for (const c of CITIES){
      [citySelect, browserCity, eventsCity].forEach(sel=>{
        const opt=document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt.cloneNode(true));
      });
    }

    // ---- Helpers ----
    const fmt = (d)=> new Date(d).toLocaleString('tr-TR',{dateStyle:'medium', timeStyle:'short'});

    async function refreshMembersUI(cityFilter = null){
      // Toplam üye
      const {count: totalCount} = await supa.from('users').select('*', {count:'exact', head:true});
      chipTotal.textContent = `${totalCount||0} total members`;

      // Liste (şehir filtresi)
      let query = supa.from('users').select('username, city').order('username', {ascending: true});
      if (cityFilter) query = query.eq('city', cityFilter);

      const { data, error } = await query;
      membersList.innerHTML = '';
      if (error){ membersList.innerHTML = `<div class="empty danger">Error: ${error.message}</div>`; return; }

      chipCity.textContent = `${(data||[]).length} in this city`;

      if (!data || data.length===0){
        membersList.innerHTML = `<div class="empty">No members yet.</div>`;
        return;
      }
      for (const row of data){
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<div>@${row.username||'unknown'}</div><div class="muted">${row.city||'-'}</div>`;
        membersList.appendChild(el);
      }
    }

    async function refreshEventsUI(city){
      const { data, error } = await supa
        .from('events')
        .select('id, title, city, description, venue, event_date, created_by, users(username)')
        .eq('city', city)
        .order('event_date', { ascending:true });

      eventsList.innerHTML = '';
      if (error){ eventsList.innerHTML = `<div class="empty danger">Error: ${error.message}</div>`; return; }
      if (!data || data.length===0){ eventsList.innerHTML = `<div class="empty">No events for this city yet.</div>`; return; }

      for (const ev of data){
        const by = ev.users?.username ? `@${ev.users.username}` : 'someone';
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <div>
            <div style="font-weight:600">${ev.title}</div>
            <div class="muted">${fmt(ev.event_date)} — ${ev.venue||'-'}</div>
            ${ev.description ? `<div class="muted">${ev.description}</div>`:''}
          </div>
          <div class="muted">by ${by}</div>
        `;
        eventsList.appendChild(el);
      }
    }

    async function loadSession(){
      const { data:{session} } = await supa.auth.getSession();
      if (!session){
        // signed-out
        btnDiscord.disabled=false;
        citySelect.disabled=true; btnSaveCity.disabled=true;
        joinHint.textContent = "You must connect Discord to add your city.";
        eventsInfo.textContent = "Only signed-in users can create events.";
        formEvent.style.display = 'none';
      }else{
        const user = session.user;
        btnDiscord.textContent = "Connected";
        btnDiscord.disabled = true;

        citySelect.disabled=false; btnSaveCity.disabled=false;
        joinHint.innerHTML = `Signed in as <b>@${user.user_metadata?.user_name || user.user_metadata?.full_name || 'discord-user'}</b>. Select your city and save.`;

        // Events form aktif
        eventsInfo.innerHTML = `<span class="good">Signed in:</span> you can create events.`;
        formEvent.style.display = 'block';
      }
      // initial loads
      await refreshMembersUI(browserCity.value);
      await refreshEventsUI(eventsCity.value);
    }

    // ---- Handlers ----
    btnDiscord.addEventListener('click', async ()=>{
      btnDiscord.disabled = true;
      const redirectTo = window.location.origin + '/';
      const { error } = await supa.auth.signInWithOAuth({
        provider:'discord',
        options:{ redirectTo }
      });
      if (error){ alert('Discord auth error: ' + error.message); btnDiscord.disabled=false; }
    });

    btnSaveCity.addEventListener('click', async ()=>{
      const { data:{session} } = await supa.auth.getSession();
      if (!session){ alert('Please sign in first.'); return; }
      const user = session.user;

      const city = citySelect.value;
      const username = user.user_metadata?.user_name || user.user_metadata?.full_name || 'discord-user';

      // upsert users row (id = auth.user.id)
      const { error } = await supa
        .from('users')
        .upsert({ id: user.id, username, city }, { onConflict:'id' });

      if (error){ alert('Save error: ' + error.message); return; }
      await refreshMembersUI(browserCity.value);
      alert('Your city has been saved.');
    });

    browserCity.addEventListener('change', ()=> refreshMembersUI(browserCity.value));
    btnShowAll.addEventListener('click', ()=>{ browserCity.value = browserCity.options[0].value; refreshMembersUI(null); });

    eventsCity.addEventListener('change', ()=> refreshEventsUI(eventsCity.value));

    formEvent.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const { data:{session} } = await supa.auth.getSession();
      if (!session){ alert('Please sign in first.'); return; }

      const city = eventsCity.value;
      const title = eventTitle.value.trim();
      const dt    = eventDate.value;
      const venue = eventVenue.value.trim();
      const desc  = eventDesc.value.trim();

      if (!title || !dt){ alert('Please enter title and date.'); return; }

      const { error } = await supa.from('events').insert({
        id: crypto.randomUUID(),
        city, title, description: desc, venue,
        event_date: new Date(dt).toISOString(),
        created_by: session.user.id
      });
      if (error){ alert('Create error: ' + error.message); return; }

      eventTitle.value=''; eventDate.value=''; eventVenue.value=''; eventDesc.value='';
      await refreshEventsUI(city);
      alert('Event created.');
    });

    // Auth state change (örn. giriş sonrası dönüş)
    supa.auth.onAuthStateChange((_e, _s)=> loadSession());

    // Start
    loadSession();
  </script>
</body>
</html>
