<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sentient Türkiye Community Map — GemBatu</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--card:rgba(0,0,0,.72);--fg:#eaf2ff;--muted:#aab6d1;--btn:#2563eb;--btnh:#1d4ed8}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--fg);
      background:url("assets/bg.jpg") no-repeat center center fixed;background-size:cover;}
    .container{max-width:1100px;margin:0 auto;padding:28px 16px;}
    h2{margin:0 0 16px 0;text-shadow:0 2px 10px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .stack{display:grid;gap:16px}
    .card{background:rgba(0,0,0,.72);border-radius:14px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25);backdrop-filter:blur(6px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label.small{font-size:12px;color:var(--muted)}
    select,input,textarea,button{width:100%;padding:10px 12px;border:0;border-radius:10px;outline:none}
    select,input,textarea{background:#0f172a;color:#e5edff}
    textarea{min-height:72px;resize:vertical}
    button{background:var(--btn);color:#fff;cursor:pointer;font-weight:600}
    button:hover{background:var(--btnh)}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1222;color:#cfe1ff}
    .list div{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)}
    .muted{color:var(--muted)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h2>Sentient Türkiye Community Map — <b>GemBatu</b> <span class="muted" style="font-size:12px">(production)</span></h2>

    <div class="grid">
      <!-- LEFT -->
      <div class="stack">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Join the map</h3>
            <label class="small">(When you log in here, your Discord username will be visible to everyone)</label>
          </div>

          <div class="row">
            <button id="btnLogin" style="max-width:220px">Sign in with Discord</button>
            <span id="loginStatus" class="pill">Not connected</span>
          </div>

          <label class="small">Select your city (Türkiye)</label>
          <select id="citySelect"></select>

          <div class="row" style="justify-content:flex-end">
            <button id="btnSaveCity" style="max-width:180px">Save my entry</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Community events</h3>
          <label class="small">City</label>
          <select id="eventCity"></select>

          <input id="eventTitle" placeholder="Event title (e.g., Eskişehir meetup)" />
          <input id="eventDate" type="datetime-local"/>
          <input id="eventVenue" placeholder="Venue / address" />
          <textarea id="eventDesc" placeholder="Short description (optional)"></textarea>

          <div class="row" style="justify-content:flex-end">
            <button id="btnCreateEvent" style="max-width:160px">Create event</button>
          </div>

          <div id="eventsList" class="list muted">No events for this city yet.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3 style="margin-top:0">City browser</h3>
        <div class="row">
          <select id="browserCity" style="flex:1"></select>
          <button id="btnShowAll" style="max-width:120px">Show all</button>
        </div>

        <div class="row" style="gap:12px;margin-top:6px">
          <span id="totalCount" class="pill">0 total members</span>
          <span id="cityCount" class="pill">0 in this city</span>
        </div>

        <div id="membersList" class="list muted" style="margin-top:10px">No members yet.</div>
      </div>
    </div>
  </div>

  <script>
    // --- Supabase ---
    const SUPABASE_URL = "https://zooclwpqfwpzwosnqjem.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- UI refs ---
    const btnLogin = document.getElementById('btnLogin');
    const loginStatus = document.getElementById('loginStatus');
    const citySelect = document.getElementById('citySelect');
    const btnSaveCity = document.getElementById('btnSaveCity');

    const browserCity = document.getElementById('browserCity');
    const btnShowAll = document.getElementById('btnShowAll');
    const membersList = document.getElementById('membersList');
    const totalCount = document.getElementById('totalCount');
    const cityCount = document.getElementById('cityCount');

    const eventCity = document.getElementById('eventCity');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventVenue = document.getElementById('eventVenue');
    const eventDesc = document.getElementById('eventDesc');
    const btnCreateEvent = document.getElementById('btnCreateEvent');
    const eventsList = document.getElementById('eventsList');

    // --- Cities (81) ---
    const CITIES = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur",
      "Bursa","Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan",
      "Erzurum","Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkâri","Hatay","Iğdır","Isparta","İstanbul",
      "İzmir","Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir",
      "Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş",
      "Nevşehir","Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas",
      "Şanlıurfa","Şırnak","Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];
    function fillCitySelect(el, includeAll=false){
      el.innerHTML = "";
      if(includeAll){
        const opt = document.createElement('option');
        opt.value = "ALL"; opt.textContent = "All cities";
        el.appendChild(opt);
      }
      CITIES.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;el.appendChild(o);});
    }
    fillCitySelect(citySelect);
    fillCitySelect(eventCity);
    fillCitySelect(browserCity, true);

    // --- Helpers ---
    function getDiscordIdFromSession(session){
      const ids = session?.user?.identities || [];
      const d = ids.find(i=>i.provider==="discord");
      const fromIdentities = d?.identity_data?.user_id || d?.id;
      const fromMeta = session?.user?.user_metadata?.provider_id || session?.user?.user_metadata?.sub;
      return fromIdentities || fromMeta || null;
    }
    function currentBrowserCity(){ const v=browserCity.value; return (v && v!=="ALL") ? v : null; }

    // --- Auth ---
    btnLogin.addEventListener('click', async ()=>{
      const { error } = await supa.auth.signInWithOAuth({
        provider: 'discord',
        options: { redirectTo: window.location.origin }
      });
      if(error) alert("Login error: " + error.message);
    });

    async function reflectSession(){
      const { data:{session} } = await supa.auth.getSession();
      if(session){
        const nick = session.user.user_metadata?.user_name || session.user.email || "discord-user";
        loginStatus.textContent = "Connected as @" + nick;
      } else {
        loginStatus.textContent = "Not connected";
      }
    }

    // Kullanıcının kayıtlı şehrini al ve eventCity varsayılanını ona ayarla
    async function setEventCityFromProfile(){
      const { data:{session} } = await supa.auth.getSession();
      if(!session) return;
      const { data } = await supa.from('users').select('city').eq('id', session.user.id).maybeSingle();
      if(data?.city && CITIES.includes(data.city)){
        eventCity.value = data.city;
        await refreshEvents(eventCity.value);
      }
    }

    // --- Save city ---
    btnSaveCity.addEventListener('click', async ()=>{
      const { data:{session} } = await supa.auth.getSession();
      if(!session){ alert("Please sign in first."); return; }
      const user = session.user;
      const city = citySelect.value;
      if(!city){ alert("Please select a city"); return; }

      const username = user.user_metadata?.user_name || user.user_metadata?.full_name || 'discord-user';
      const discordId = getDiscordIdFromSession(session);
      const payload = { id: user.id, username, city };
      if(discordId) payload.discord_id = discordId;

      const { error } = await supa.from('users').upsert(payload, { onConflict: 'id' });
      if(error){ alert("Save error: " + error.message); return; }

      await refreshMembersUI(currentBrowserCity());
      // event formu için varsayılan şehir olarak kullanıcının şehrini set et
      eventCity.value = city;
      await refreshEvents(city);
      alert("Your city has been saved.");
    });

    // --- Members browser ---
    async function refreshMembersUI(selectedCity=null){
      const total = await supa.from('users').select('id');
      totalCount.textContent = (total.data?.length || 0) + " total members";

      let q = supa.from('users').select('username,city').order('username',{ascending:true});
      if(selectedCity) q = q.eq('city', selectedCity);

      const { data, error } = await q;
      if(error){ membersList.innerHTML = "Error: "+error.message; return; }

      cityCount.textContent = (data?.length || 0) + " in this city";
      membersList.innerHTML = (!data || data.length===0)
        ? "No members yet."
        : data.map(u=>`<div>@${u.username} — ${u.city}</div>`).join('');
    }
    browserCity.addEventListener('change', ()=> refreshMembersUI(currentBrowserCity()));
    btnShowAll.addEventListener('click', ()=>{ browserCity.value="ALL"; refreshMembersUI(null); });

    // --- Events ---
    async function refreshEvents(city){
      let q = supa.from('events').select('title,event_date,venue,description,city').order('event_date',{ascending:true});
      if(city) q = q.eq('city', city);
      const { data, error } = await q;
      if(error){ eventsList.innerHTML = "Error: "+error.message; return; }
      if(!data || data.length===0){ eventsList.innerHTML = "No events for this city yet."; return; }
      eventsList.innerHTML = data.map(e=>{
        const dt = e.event_date ? new Date(e.event_date).toLocaleString() : "";
        return `<div><b>${e.title}</b> — ${e.city}<br>${dt}${e.venue?` @ ${e.venue}`:""}<br><span class="muted">${e.description||""}</span></div>`;
      }).join('<div style="height:8px"></div>');
    }

    btnCreateEvent.addEventListener('click', async ()=>{
      const { data:{session} } = await supa.auth.getSession();
      if(!session){ alert("Please sign in first."); return; }

      const payload = {
        city: eventCity.value,
        title: eventTitle.value.trim(),
        event_date: eventDate.value ? new Date(eventDate.value).toISOString() : null, // <-- ISO/UTC
        venue: eventVenue.value.trim(),
        description: eventDesc.value.trim(),
        created_by: session.user.id
      };
      if(!payload.title || !payload.city){ alert("Please fill city and title"); return; }

      const { error } = await supa.from('events').insert(payload);
      if(error){ alert("Error: "+error.message); return; }

      eventTitle.value=""; eventVenue.value=""; eventDesc.value="";
      await refreshEvents(eventCity.value);
      alert("Event created.");
    });

    // --- Realtime (members & events) ---
    supa.channel('realtime-users')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'users'}, ()=> refreshMembersUI(currentBrowserCity()))
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'users'}, ()=> refreshMembersUI(currentBrowserCity()))
      .subscribe();

    // Events: INSERT + UPDATE + DELETE → seçili şehri yenile
    supa.channel('realtime-events')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'events'}, ()=> refreshEvents(eventCity.value))
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'events'}, ()=> refreshEvents(eventCity.value))
      .on('postgres_changes',{event:'DELETE',schema:'public',table:'events'}, ()=> refreshEvents(eventCity.value))
      .subscribe();

    // --- Init ---
    (async ()=>{
      await reflectSession();
      await refreshMembersUI(null);
      await setEventCityFromProfile(); // <-- kullanıcı şehrine göre varsayılan eventCity
      await refreshEvents(eventCity.value);

      supa.auth.onAuthStateChange(async ()=>{ await reflectSession(); await setEventCityFromProfile(); });
    })();
  </script>
</body>
</html>
