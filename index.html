<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sentient Türkiye Community Map — GemBatu (production)</title>

  <!-- Supabase -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg:#0e1420; --panel:#101826; --txt:#e5ecfb; --muted:#9fb0c8;
      --edge:#20304b; --ring:#2a3b55; --grad1:#192742; --grad2:#0f1a2a;
      --blue:#2563eb; --blue2:#1e40af;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt);
      font:500 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg) center/cover fixed url("assets/bg.jpg");
    }
    .wrap{max-width:1120px; margin:28px auto 72px; padding:0 20px}
    h1{margin:0 0 18px; font-size:22px}
    h1 .pill{margin-left:8px; padding:2px 8px; font-size:12px; border-radius:999px;
      background:#1b2942; border:1px solid var(--edge); color:#cde0ff}
    h3{margin:0 0 10px; font-size:16px}

    .grid{display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start}
    .panel{
      position:relative; z-index:1;
      padding:18px; border-radius:14px;
      background:linear-gradient(180deg,var(--grad1),var(--grad2));
      border:1px solid var(--edge);
      box-shadow:0 8px 28px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }
    .panel.auth{z-index:3} .panel.browser{z-index:2} .panel.events{grid-column:1 / span 2}

    .row{display:flex; align-items:center; gap:10px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:38px; padding:0 14px; border-radius:10px; cursor:pointer;
      border:1px solid var(--ring); background:#122038; color:var(--txt);
      text-decoration:none; user-select:none;
    }
    .btn.primary{background:linear-gradient(180deg,var(--blue),var(--blue2)); border-color:#1f3d8a}
    .btn:active{transform:translateY(1px)}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--ring); background:#16243c; color:#cfe0ff}

    select, input[type="text"], input[type="datetime-local"], textarea{
      width:100%; height:40px; border-radius:10px; outline:none;
      color:var(--txt); background:#0f1a26; border:1px solid #243653; padding:0 12px;
    }
    textarea{height:72px; padding:10px 12px; resize:vertical}
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    .muted{color:var(--muted)}

    .list{display:flex; flex-direction:column; gap:8px; margin-top:12px}
    .item{padding:10px 12px; border:1px solid #22324d; background:#0e192b; border-radius:10px}

    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      .panel.events{grid-column:auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sentient Türkiye Community Map — GemBatu <span class="pill">production</span></h1>

    <div class="grid">
      <!-- LEFT: Join -->
      <section class="panel auth">
        <h3>Join the map</h3>
        <p id="authNote" class="muted">You must connect Discord to add your city.</p>
        <div class="row" style="margin-top:8px">
          <a id="discordBtn" class="btn primary">Sign in with Discord</a>
        </div>

        <div id="joinForm" style="display:none; margin-top:14px">
          <label>Select your city (Türkiye)</label>
          <select id="joinCity"></select>
          <div class="row" style="margin-top:10px">
            <button id="saveEntry" class="btn primary">Save my entry</button>
          </div>
          <div id="meBox" class="muted" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- RIGHT: Browser -->
      <section class="panel browser">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:8px">
            <select id="browserCity" style="min-width:220px"></select>
            <span id="totalCount" class="badge">0 total members</span>
            <span id="inCityCount" class="badge">0 in this city</span>
          </div>
          <button id="showAll" class="btn">Show all</button>
        </div>
        <div id="memberList" class="list"></div>
      </section>

      <!-- EVENTS -->
      <section class="panel events">
        <h3>Community events</h3>
        <div class="row" style="gap:8px; margin-top:8px">
          <select id="eventCity" style="min-width:220px"></select>
        </div>
        <div style="margin-top:8px">
          <input id="eventTitle" type="text" placeholder="Event title (e.g., Eskişehir meetup)"/>
        </div>
        <div class="row" style="gap:8px; margin-top:8px">
          <input id="eventDate" type="datetime-local"/>
          <input id="eventVenue" type="text" placeholder="Venue / address"/>
        </div>
        <div style="margin-top:8px">
          <textarea id="eventDesc" placeholder="Short description (optional)"></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="createEvent" class="btn primary">Create event</button>
        </div>

        <div id="eventList" class="list"></div>
      </section>
    </div>
  </div>

  <script>
    /************ FIXED CONFIG (senin verdiğin değerler) ************/
    const SB_URL  = "https://zooclwpqfwpzwosnqjem.supabase.co";
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0";
    const DISCORD_CLIENT_ID = "1409378760029110422";   // ← Client ID

    const DISCORD_SCOPE = "identify";
    // Çalıştığı domaini otomatik kullan (localhost / vercel).
    const DISCORD_REDIRECT_URI = location.origin + location.pathname;

    // Şehir listesi
    const CITIES_TR = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa",
      "Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan","Erzurum",
      "Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul","İzmir",
      "Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kırıkkale","Kırklareli","Kırşehir",
      "Kilis","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş","Nevşehir",
      "Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Şanlıurfa","Siirt","Sinop","Şırnak","Sivas",
      "Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];

    /************ INIT ************/
    const supabase = window.supabase.createClient(SB_URL, SB_ANON);

    // UI refs
    const joinCity = document.getElementById('joinCity');
    const saveEntryBtn = document.getElementById('saveEntry');
    const meBox = document.getElementById('meBox');
    const authNote = document.getElementById('authNote');
    const discordBtn = document.getElementById('discordBtn');

    const browserCity = document.getElementById('browserCity');
    const totalCount = document.getElementById('totalCount');
    const inCityCount = document.getElementById('inCityCount');
    const memberList = document.getElementById('memberList');
    const showAllBtn = document.getElementById('showAll');

    const eventCity = document.getElementById('eventCity');
    const eventTitle = document.getElementById('eventTitle');
    const eventDate = document.getElementById('eventDate');
    const eventVenue = document.getElementById('eventVenue');
    const eventDesc = document.getElementById('eventDesc');
    const createEventBtn = document.getElementById('createEvent');
    const eventList = document.getElementById('eventList');

    // Select’leri doldur
    [joinCity,browserCity,eventCity].forEach(sel=>{
      sel.innerHTML = CITIES_TR.map(c=>`<option value="${c}">${c}</option>`).join('');
    });

    // Discord OAuth URL ve buton
    const discordAuthUrl =
      `https://discord.com/api/oauth2/authorize` +
      `?client_id=${encodeURIComponent(DISCORD_CLIENT_ID)}` +
      `&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}` +
      `&response_type=token` +
      `&scope=${encodeURIComponent(DISCORD_SCOPE)}`;

    discordBtn.setAttribute('href', discordAuthUrl);
    discordBtn.setAttribute('target','_self');

    // Redirect sonrası token varsa profil çek
    (function handleDiscordRedirect(){
      const hash = new URLSearchParams(location.hash.slice(1));
      const token = hash.get('access_token');
      if(!token) return;

      history.replaceState(null,'',location.pathname + location.search);

      fetch('https://discord.com/api/users/@me', { headers:{Authorization:`Bearer ${token}`} })
        .then(r=>r.json())
        .then(user=>{
          document.getElementById('joinForm').style.display = 'block';
          authNote.textContent = "Connected ✓ — select your city and save your entry.";
          meBox.innerHTML = `Logged in as <strong>@${user.global_name || user.username}</strong>`;
          localStorage.setItem('discord_user', JSON.stringify({
            id: user.id, username: user.username, global_name: user.global_name || null
          }));
        })
        .catch(console.error);
    })();

    /** Helpers **/
    const el = (html)=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; };

    /** Members **/
    async function loadMembers(){
      const { data, error } = await supabase.from('users').select('discord_id,username,city,created_at').order('created_at',{ascending:false});
      if(error){ console.error(error); return; }
      totalCount.textContent = `${data.length} total members`;
      renderMemberList(data);
      browserCity.onchange = ()=>renderMemberList(data);
      showAllBtn.onclick = ()=>{ browserCity.value=""; renderMemberList(data,true); };
    }
    function renderMemberList(all, showAll=false){
      const c = browserCity.value;
      const list = showAll || !c ? all : all.filter(x=>x.city===c);
      inCityCount.textContent = `${list.length} in this city`;
      memberList.innerHTML = list.length
        ? list.map(u=>`<div class="item">
            <div><strong>@${u.username}</strong> <span class="muted">• ${u.city}</span></div>
            <div class="muted" style="font-size:12px">${new Date(u.created_at).toLocaleString()}</div>
          </div>`).join('')
        : `<div class="muted">No members yet.</div>`;
    }

    /** Events **/
    async function loadEvents(){
      const { data, error } = await supabase.from('events')
        .select('id, city, title, event_date, venue, description, created_at, users(username)')
        .order('event_date', { ascending:true });
      if(error){ console.error(error); return; }
      renderEvents(data);
      eventCity.onchange = ()=>renderEvents(data);
    }
    function renderEvents(all){
      const c = eventCity.value;
      const list = all.filter(x=>x.city===c);
      eventList.innerHTML = list.length
        ? list.map(e=>{
            const when = new Date(e.event_date).toLocaleString();
            const by = e.users?.username ? `by @${e.users.username}` : '';
            return `<div class="item">
              <div><strong>${e.title}</strong> <span class="muted">· ${e.city}</span></div>
              <div class="muted" style="font-size:13px">${when} — ${e.venue || '-'}</div>
              ${e.description ? `<div class="muted" style="margin-top:4px">${e.description}</div>`:''}
              <div class="muted" style="font-size:12px; margin-top:6px">${by}</div>
            </div>`;
          }).join('')
        : `<div class="muted">No events for this city yet.</div>`;
    }

    /** Actions **/
    document.getElementById('saveEntry').onclick = async ()=>{
      const u = JSON.parse(localStorage.getItem('discord_user')||'null');
      if(!u){ alert('Please sign in with Discord first.'); return; }
      const city = joinCity.value;
      const username = (u.global_name || u.username || '').toString();
      const { error } = await supabase.from('users').upsert(
        { discord_id: u.id, username, city }, { onConflict:'discord_id' }
      );
      if(error){ alert('Save failed.'); console.error(error); return; }
      alert('Saved!'); loadMembers();
    };

    document.getElementById('createEvent').onclick = async ()=>{
      const u = JSON.parse(localStorage.getItem('discord_user')||'null');
      if(!u){ alert('Please sign in with Discord first.'); return; }

      const payload = {
        city: eventCity.value,
        title: eventTitle.value.trim(),
        description: eventDesc.value.trim() || null,
        event_date: eventDate.value ? new Date(eventDate.value).toISOString() : null,
        venue: eventVenue.value.trim() || null
      };
      if(!payload.title || !payload.event_date){ alert('Please enter title and date.'); return; }

      // creator eşleştirme
      const { data: me } = await supabase.from('users').select('id').eq('discord_id', u.id).single();
      if(!me){ alert('Add yourself to the map first (save entry).'); return; }

      const { error } = await supabase.from('events').insert({ ...payload, created_by: me.id });
      if(error){ alert('Create failed.'); console.error(error); return; }

      eventTitle.value=''; eventVenue.value=''; eventDesc.value=''; eventDate.value='';
      loadEvents();
    };

    // boot
    (async()=>{ await loadMembers(); await loadEvents(); })();
  </script>
</body>
</html>
