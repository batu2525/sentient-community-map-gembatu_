<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentient Türkiye Community Map — GemBatu</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0f1422; --panel:#111a2a; --panel2:#0d1726; --text:#e7eefc; --muted:#9db2cc;
      --accent:#5aa7ff; --accent-2:#9cd1ff; --ring:0 0 0 2px rgba(90,167,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); background:var(--bg) center/cover fixed;
      background-image:url("/assets/bg.jpg");
      font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
    }
    .wrap{max-width:1100px;margin:48px auto;padding:0 16px;}
    h1{font-size:22px;margin:0 0 12px;display:flex;gap:12px;align-items:center}
    .badge{font-size:12px;color:#0b1220;background:#d9ecff;padding:2px 8px;border-radius:999px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr;}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3);
      backdrop-filter:saturate(1.1) blur(2px);
    }
    .title{font-weight:600;margin-bottom:8px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .row{display:flex;gap:10px;align-items:center}
    select,input,button,textarea{
      width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
      background:#0b1322;color:var(--text);outline:none;transition:.15s;
    }
    select:focus,input:focus,textarea:focus{box-shadow:var(--ring);border-color:#3a8fff}
    button{
      cursor:pointer;background:linear-gradient(180deg,#2e7bff,#1f5ed8);
      border:1px solid #2b67e0;font-weight:600;
    }
    button:hover{filter:brightness(1.05)}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    ul.members{list-style:none;margin:10px 0 0;padding:0;max-height:360px;overflow:auto}
    ul.members li{padding:10px 12px;border-radius:10px;background:#0c1526;border:1px solid rgba(255,255,255,.06);margin-bottom:8px}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;background:#0e1a30;border:1px solid rgba(255,255,255,.06);color:var(--accent-2)}
    .right{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      Sentient Türkiye Community Map — GemBatu
      <span class="badge">production</span>
    </h1>

    <div class="grid">
      <!-- LEFT: Join the map -->
      <section class="card">
        <div class="title">Join the map</div>
        <p class="muted" id="loginHint">You must connect Discord to add your city.</p>
        <div class="row" style="margin-bottom:10px">
          <button id="discordBtn" style="max-width:240px">Sign in with Discord</button>
          <span id="whoami" class="muted"></span>
        </div>

        <label for="citySelect">Select your city (Türkiye)</label>
        <select id="citySelect"></select>

        <div class="row" style="margin-top:10px">
          <button id="saveBtn" style="max-width:180px">Save my entry</button>
        </div>
      </section>

      <!-- RIGHT: City browser -->
      <section class="card">
        <div class="toolbar">
          <div class="title">City browser</div>
          <div class="right">
            <select id="browserCity" style="min-width:180px"></select>
            <button id="showAllBtn" title="Show everyone">Show all</button>
          </div>
        </div>
        <div class="row" style="gap:8px">
          <span class="pill"><span id="membersCounter">0</span> total members</span>
          <span class="pill"><span id="cityCounter">0</span> in this city</span>
        </div>
        <ul id="membersList" class="members"><li class="muted">No members yet.</li></ul>
      </section>
    </div>
  </div>

  <script>
    // --- 0) CONFIG ---
    const SUPABASE_URL = 'https://zooclwpqfwpzwosnqjem.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvb2Nsd3BxZndwendvc25xamVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwODczNjUsImV4cCI6MjA3MTY2MzM2NX0.lCW2dSb7HV3vuXKNa_QFJ0o5I4522RE8CS-PDmOflk0';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // --- 1) CITY LISTS ---
    const citiesTR = [
      "Adana","Adıyaman","Afyonkarahisar","Ağrı","Aksaray","Amasya","Ankara","Antalya","Ardahan","Artvin",
      "Aydın","Balıkesir","Bartın","Batman","Bayburt","Bilecik","Bingöl","Bitlis","Bolu","Burdur","Bursa",
      "Çanakkale","Çankırı","Çorum","Denizli","Diyarbakır","Düzce","Edirne","Elazığ","Erzincan","Erzurum",
      "Eskişehir","Gaziantep","Giresun","Gümüşhane","Hakkari","Hatay","Iğdır","Isparta","İstanbul","İzmir",
      "Kahramanmaraş","Karabük","Karaman","Kars","Kastamonu","Kayseri","Kilis","Kırıkkale","Kırklareli",
      "Kırşehir","Kocaeli","Konya","Kütahya","Malatya","Manisa","Mardin","Mersin","Muğla","Muş","Nevşehir",
      "Niğde","Ordu","Osmaniye","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Şanlıurfa","Şırnak",
      "Tekirdağ","Tokat","Trabzon","Tunceli","Uşak","Van","Yalova","Yozgat","Zonguldak"
    ];
    function fillCitySelect(el, addAll=false){
      el.innerHTML='';
      if(addAll){ const opt=document.createElement('option'); opt.value='All cities'; opt.textContent='All cities'; el.appendChild(opt); }
      citiesTR.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; el.appendChild(o); });
    }
    const citySelect = document.getElementById('citySelect');
    const browserCity = document.getElementById('browserCity');
    fillCitySelect(citySelect);
    fillCitySelect(browserCity,true);

    // --- 2) AUTH (Discord) ---
    const discordBtn = document.getElementById('discordBtn');
    const whoami = document.getElementById('whoami');
    const loginHint = document.getElementById('loginHint');

    async function signInWithDiscord(){
      const redirectTo = window.location.origin; // vercel domaininiz otomatik
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'discord',
        options: { redirectTo, scopes: 'identify' }
      });
      if(error) alert('Discord sign-in failed: '+error.message);
    }
    discordBtn.addEventListener('click', signInWithDiscord);

    async function setWhoAmI(){
      const { data:{user} } = await supabase.auth.getUser();
      if(user){
        const m = user.user_metadata||{};
        const name = m.global_name || m.username || m.full_name || m.name || 'Discord User';
        whoami.textContent = `@${name}`;
        loginHint.textContent = 'Connected. Pick your city and save.';
        discordBtn.textContent = 'Connected ✓';
        discordBtn.disabled = true;
      } else {
        whoami.textContent = '';
        loginHint.textContent = 'You must connect Discord to add your city.';
        discordBtn.textContent = 'Sign in with Discord';
        discordBtn.disabled = false;
      }
    }

    // --- 3) SAVE CITY (RLS uyumlu upsert: id = user.id ZORUNLU) ---
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.addEventListener('click', saveCity);

    async function saveCity(){
      const { data:{user}, error:authErr } = await supabase.auth.getUser();
      if(authErr || !user){ alert('Please sign in with Discord first.'); return; }

      const city = citySelect.value;
      if(!city){ alert('Pick a city'); return; }

      const meta = user.user_metadata || {};
      const nickname =
        meta.global_name || meta.username || meta.preferred_username ||
        meta.full_name  || meta.name     || 'Discord User';

      const { error } = await supabase.from('users').upsert({
        id: user.id,                 // <<< KRİTİK: RLS için auth.uid()
        discord_id: user.id,
        username: nickname,
        city
      });

      if(error){
        console.error(error);
        alert('Save failed: '+error.message);
        return;
      }
      await refreshCityList(); // sağ paneli tazele
      alert('Saved!');
    }

    // --- 4) CITY BROWSER ---
    const membersList = document.getElementById('membersList');
    const membersCounter = document.getElementById('membersCounter');
    const cityCounter = document.getElementById('cityCounter');
    document.getElementById('showAllBtn').addEventListener('click', ()=>{
      browserCity.value = 'All cities';
      refreshCityList();
    });
    browserCity.addEventListener('change', refreshCityList);

    async function refreshCityList(){
      const chosen = browserCity.value;
      let q = supabase.from('users').select('username, city');
      if(chosen && chosen!=='All cities') q = q.eq('city', chosen);

      const { data, error } = await q.order('username', { ascending:true });

      membersList.innerHTML='';
      if(error){
        membersList.innerHTML = `<li class="muted">Error loading members.</li>`;
        membersCounter.textContent='0'; cityCounter.textContent='0';
        return;
      }
      membersCounter.textContent = String(data.length);

      if(chosen && chosen!=='All cities'){
        cityCounter.parentElement.style.display='';
        cityCounter.textContent = String(data.length);
      }else{
        cityCounter.parentElement.style.display='none';
      }

      if(!data.length){
        membersList.innerHTML = `<li class="muted">No members yet.</li>`;
        return;
      }
      data.forEach(r=>{
        const li=document.createElement('li');
        li.textContent = `@${r.username} — ${r.city}`;
        membersList.appendChild(li);
      });
    }

    // --- 5) İlk yükte auth & listeyi toparla ---
    setWhoAmI().then(refreshCityList);
    supabase.auth.onAuthStateChange((_e)=>{ setWhoAmI(); refreshCityList(); });
  </script>
</body>
</html>
